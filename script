#!/usr/bin/env bash

trap 'pkill -P $$' EXIT

if [[ ! $# -eq 1 ]]; then
    echo "Usage: $0 <JOBS>"
    exit 1
fi

rm -rf build

for i in $(seq 1 $1); do
    (
        set -e
    	mkdir -p build/$i
    	# make sure ccache is not used
    	cmake -B build/$i -S . -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=/usr/bin/clang++
        while true;
        do
            cmake --build build/$i -j 1 --clean-first
        done
    ) &
done

wait -n
exit_code=$?

exit $exit_code
